<template>
  <n-layout>
    <n-layout-header>
      <n-grid cols="4 600:8">
        <n-grid-item class="menu" :span="4">
          <n-icon size="40">
            <svg width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_1101_2091)">
            <path d="M76 0H0V76H76V0Z" fill="url(#paint0_linear_1101_2091)"/>
            <g filter="url(#filter0_d_1101_2091)">
            <path d="M44.7711 45.8668C46.2768 45.8668 47.4974 44.6474 47.4974 43.1431C47.4974 41.6389 46.2768 40.4194 44.7711 40.4194C43.2655 40.4194 42.0449 41.6389 42.0449 43.1431C42.0449 44.6474 43.2655 45.8668 44.7711 45.8668Z" fill="url(#paint1_linear_1101_2091)" fill-opacity="0.88"/>
            </g>
            <g filter="url(#filter1_d_1101_2091)">
            <path d="M54.519 54.0363C53.9906 54.5103 53.202 54.9684 52.1916 55.1256C50.8113 55.34 49.3873 54.9064 48.0044 53.8792C53.4891 50.3246 57.1183 44.1538 57.1183 37.1353C57.1183 26.1203 48.1805 17.1909 37.1552 17.1909C26.1299 17.1909 17.1914 26.1203 17.1914 37.136C17.1914 48.1517 26.1292 57.0808 37.1552 57.0808C39.7348 57.0808 42.2003 56.5923 44.4639 55.7023C47.1061 58.2505 49.6616 58.8636 51.5065 58.8636C51.973 58.8636 52.3939 58.825 52.7596 58.7679C55.99 58.2646 58.2466 56.0097 58.8097 54.037H54.5195L54.519 54.0363ZM38.5979 22.6376C46.7895 22.6376 53.43 29.2719 53.43 37.4557C53.43 43.3014 50.0415 48.3552 45.1208 50.7665C45.0502 50.6645 44.9803 50.561 44.911 50.4562C42.451 46.7418 39.3678 44.5541 35.7473 43.953C31.9454 43.3209 28.4608 44.628 26.3073 45.7538C24.7025 43.3861 23.7653 40.5307 23.7653 37.4557C23.7653 29.2719 30.4058 22.6376 38.5973 22.6376H38.5979ZM28.8447 48.6198C30.5013 47.8729 32.7959 47.1912 35.1665 47.5922C37.5707 47.9986 39.6965 49.4776 41.4923 51.9917C40.5564 52.1764 39.5883 52.2745 38.5979 52.2745C34.8639 52.2745 31.4526 50.8955 28.8447 48.6198Z" fill="url(#paint2_linear_1101_2091)"/>
            </g>
            </g>
            <defs>
            <filter id="filter0_d_1101_2091" x="16.0449" y="14.4194" width="65.4521" height="65.4473" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"/>
            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
            <feOffset dx="4" dy="4"/>
            <feGaussianBlur stdDeviation="15"/>
            <feComposite in2="hardAlpha" operator="out"/>
            <feColorMatrix type="matrix" values="0 0 0 0 0.336232 0 0 0 0 0.268125 0 0 0 0 0.825 0 0 0 0.45 0"/>
            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1101_2091"/>
            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1101_2091" result="shape"/>
            </filter>
            <filter id="filter1_d_1101_2091" x="-8.80859" y="-8.80908" width="101.618" height="101.673" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix"/>
            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
            <feOffset dx="4" dy="4"/>
            <feGaussianBlur stdDeviation="15"/>
            <feComposite in2="hardAlpha" operator="out"/>
            <feColorMatrix type="matrix" values="0 0 0 0 0.336232 0 0 0 0 0.268125 0 0 0 0 0.825 0 0 0 0.45 0"/>
            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1101_2091"/>
            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1101_2091" result="shape"/>
            </filter>
            <linearGradient id="paint0_linear_1101_2091" x1="65.5548" y1="13.4374" x2="18.2248" y2="66.9692" gradientUnits="userSpaceOnUse">
            <stop stop-color="#635CE6"/>
            <stop offset="1" stop-color="#7651DE"/>
            </linearGradient>
            <linearGradient id="paint1_linear_1101_2091" x1="46.351" y1="40.4209" x2="38.0002" y2="49.9141" gradientUnits="userSpaceOnUse">
            <stop stop-color="white"/>
            <stop offset="1" stop-color="white" stop-opacity="0.78"/>
            </linearGradient>
            <linearGradient id="paint2_linear_1101_2091" x1="26.3582" y1="21.3799" x2="64.195" y2="65.2281" gradientUnits="userSpaceOnUse">
            <stop stop-color="white"/>
            <stop offset="0.282719" stop-color="white" stop-opacity="0.78"/>
            <stop offset="0.46875" stop-color="white" stop-opacity="0.754064"/>
            <stop offset="1" stop-color="white" stop-opacity="0.68"/>
            </linearGradient>
            <clipPath id="clip0_1101_2091">
            <rect width="76" height="76" rx="38" fill="white"/>
            </clipPath>
            </defs>
            </svg>
          </n-icon>
          <h2>权小潮后台</h2>
          <n-menu
            mode="horizontal"
            v-model:value="menuValue"
            :options="menuOps"
          />
        </n-grid-item>
        <n-grid-item class="user" :span="4">
          <n-text>{{ name }}</n-text>
          <n-dropdown trigger="hover" :options="operations" @select="handleSelectOperation">
            <n-button class="logout">账户管理</n-button>
          </n-dropdown>
          <n-button class="logout" @click = "showHelpText = true">问题反馈</n-button>
        </n-grid-item>
      </n-grid>
    </n-layout-header>
    <n-layout-content style="background-color: #f2f1fa; padding: 0px 10px;">
      <router-view />
    </n-layout-content>
  </n-layout>

  <n-modal
    v-model:show="showModification"
    preset="dialog"
    title="修改密码"
    positive-text="修改"
    negative-text="取消"
    :mask-closable="false"
    @positive-click="modifyPassword"
  >
    <div style="height: 20px"></div>
    <n-form ref="modifyRef" :model="modifyModel" :rules="modifyRules">
      <n-form-item path="new" label="新密码">
        <n-input
          v-model:value="modifyModel.new"
          type="password"
          show-password-on="click"
          placeholder="请输入新密码"
        />
      </n-form-item>
      <n-form-item path="confirm" label="确认密码">
        <n-input
          :disabled="!modifyModel.new"
          type="password"
          show-password-on="click"
          v-model:value="modifyModel.confirm"
          placeholder="请确认新密码"
          @keyup.enter="modifyPassword"
        />
      </n-form-item>
    </n-form>
  </n-modal>

  <n-modal v-model:show="showHelpText">
    <n-card
      style="width: 600px"
      title="问题反馈"
      :bordered="true"
      size="huge"
      role="dialog"
      aria-modal="true"
    >
        请联系浙江大学求是潮邮箱tech@zjuqsc.com
    </n-card>
  </n-modal>

</template>

<script setup>

import {
  NLayout,
  NLayoutHeader,
  NLayoutContent,
  NGrid,
  NGridItem,
  NButton,
  useMessage,
  useDialog,
  NModal,
  NForm,
  NFormItem,
  NInput,
  NDropdown,
  NCard,
  NMenu,
  NIcon,
  NText,
  NBadge,
} from "naive-ui";
import { RouterLink, RouterView, useRouter } from "vue-router";
import { mapState, useStore } from "vuex";
import { onMounted, h, ref } from "vue";
import request from "@/common/request";
import { computed, reactive } from "@vue/reactivity";

const name = computed(() => store.state.loginUser.orgName);

window.$message = useMessage();
const message = useMessage();

const dialog = useDialog();
const store = useStore();
const router = useRouter();
async function logout() {
  dialog.create({
    title: "提示",
    content: "确定退出登录？",
    positiveText: "确定",
    negativeText: "取消",
    onPositiveClick: async () => {
      console.log("logout");
      await request("/admin/logout", null, "退出登录");
      store.commit("clear");
      router.push("/login");
    },
    onNegativeClick: () => {},
  });
}

const shortName = store.state.loginUser.shortName;
const college = ref();

const helpNumber = ref(0);
const actNumber = ref(0);
const menuOps = ref([]);
const menuValue = ref("");

onMounted( async ()=>{
  if(shortName != "校会") college.value = [shortName];
  else college.value = null;
  helpNumber.value = await request(
    "/question/list/count",
    {
      status: ["Unanswered"],
      college: college.value,
    },
    "获取求助数量"
  );
  actNumber.value = await request(
    "/activity/list/count",
    {
      status: ["UnReviewed"],
    },
    "获取活动数量"
  );

  menuValue.value = router.currentRoute.value.name;
  const identity = store.state.loginUser.identity;
  if(identity === "校学生会"){
    menuOps.value = [
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'activity',
              params: { lang: 'zh-CN' }
            }
          },
          ['活动 ']
          ),
        key: 'activity',
      },
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'help',
              params: { lang: 'zh-CN' }
            }
          },
          ['求助 ', h( NBadge, { show: helpNumber.value, offset: [2, -5], dot: true })]
        ),
        key: 'help',
      },
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'review',
              params: { lang: 'zh-CN' }
            }
          },
          ['活动审核 ', h( NBadge, { show: actNumber.value, offset: [2, -5], dot: true })]
        ),
        key: 'review',
      },
    ];
  } else if(identity === "学生会"){
    menuOps.value = [
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'activity',
              params: { lang: 'zh-CN' }
            }
          },
          { default: () => '活动' }
          ),
        key: 'activity',
      },
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'help',
              params: { lang: 'zh-CN' }
            }
          },
          ['求助 ', h( NBadge, { show: helpNumber.value, offset: [2, -5], dot: true })]
        ),
        key: 'help',
      },
    ];
  } else if(identity === "社团组织"){
    menuOps.value = [
      {
        label: () => h(
          RouterLink,
          {
            to: {
              name: 'activity',
              params: { lang: 'zh-CN' }
            }
          },
          { default: () => '活动' }
          ),
        key: 'activity',
      },
    ];
  }
});

/** 账户管理选项 */
const operations = reactive([
  {
    label: "退出登录",
    key: "logout",
  },
  {
    label: "修改密码",
    key: "modify-password",
  },
]);

function handleSelectOperation(key) {
  if (key === "logout") {
    logout();
  } else if (key === "modify-password") {
    showModification.value = true;
  }
}

const showModification = ref(false);
const modifyModel = reactive({
  new: "",
  confirm: "",
});
const modifyRef = ref(null);

function validatePasswordStartWith(rule, value) {
  return (
    !!modifyModel.new &&
    modifyModel.new.startsWith(value) &&
    modifyModel.new.length >= value.length
  );
}
function validatePasswordSame(rule, value) {
  return value === modifyModel.new;
}
const modifyRules = ref({
  new: [
    {
      required: true,
      message: "需要输入新密码",
      trigger: ["input", "blur"],
    },
  ],
  confirm: [
    {
      required: true,
      message: "需要确认密码",
      trigger: ["input", "blur"],
    },
    {
      validator: validatePasswordStartWith,
      message: "两次密码输入不一致",
      trigger: "input",
    },
    {
      validator: validatePasswordSame,
      message: "两次密码输入不一致",
      trigger: ["blur", "password-input"],
    },
  ],
});
function modifyPassword() {
  modifyRef.value?.validate(async (errors) => {
    if (!errors) {
      try {
        await request(
          "/admin/update",
          {
            username: store.state.loginUser.username,
            password: modifyModel.new,
          },
          "修改密码"
        );
        message.success("修改成功");
        modifyModel.new = modifyModel.confirm = "";
        showModification.value = false;
      } catch (e) {
        console.log(e);
      }
    } else {
      showModification.value = true;
    }
  });
}

const showHelpText = ref(false);

</script>

<style>
body {
  background-color: #f2f1fb;
}
.menu {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  height: 65px;
  margin-left: 20px;
  gap: 30px;
  white-space: nowrap;
}
.n-menu-item-content {
  font-size: 14px;
  font-weight: 600;
  padding: 0px !important;
  padding-left: 10px !important;
  padding-right: 10px !important;
}
.user {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
}
.user-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.logout {
  margin-left: 10px;
  margin-right: 15px;
}
.n-layout-header {
  z-index: 10;
}
.n-layout-content {
  box-shadow: inset 0 5px 6px #00152914;
  background-color: #f5f7f9;
  padding: 0px 45px;
}
.center {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>
